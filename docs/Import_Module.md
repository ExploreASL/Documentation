# Submodules of the Import Module

----
### xASL\_bids\_AddGeneratedByField.m

**Format:**

```matlab
xASL_bids_AddGeneratedByField(x, pathJSONin[, pathJSONout])
```

**Description:**

Add the generated by field to the struct.



----
### xASL\_bids\_BIDS2Legacy.m

**Format:**

```matlab
[x] = xASL_bids_BIDS2Legacy(x[, bOverwrite])
```

**Description:**

This function converts BIDS rawdata (in pathStudy/rawdata/)
to xASL legacy derivative format (e.g. pathStudy/derivatives/ExploreASL/)

Can be updated step-by-step when ExploreASL's derivative structure moves to BIDS
NB: ask how Visits/session layer is defined in bids-matlab (should be
separate layer within subjects, but now isn't?)

This function performs the following steps:

1. Parse a folder using bids-matlab
2. Define SubjectSession
3. Define Session
4. Parse modality
- Parse scantype
- Compile paths for copying
- Manage sidecars to copy
- Copy files
5. Parse M0
6. Clean up



----
### xASL\_bids\_BIDS2Legacy\_CompilePathsForCopying.m

**Format:**

```matlab
[bidsPar, TypeIs, pathOrig, pathDest] = xASL_bids_BIDS2Legacy_CompilePathsForCopying(bidsPar, TypeIs, ModalityIs, RunIs, iSubjSess, BIDS, TypeRunIndex, ModalityFields, pathLegacy_SubjectVisit)
```

**Description:**

Compile paths for BIDS to Legacy copying.



----
### xASL\_bids\_BIDS2Legacy\_ManageSidecars.m

**Format:**

```matlab
[bidsPar, pathOrig, pathDest, TypeIs] = xASL_bids_BIDS2Legacy_ManageSidecars(bidsPar, pathOrig, pathDest, TypeIs)
```

**Description:**

Manage JSON sidecars for BIDS2Legacy conversion.



----
### xASL\_bids\_BIDS2Legacy\_ParseModality.m

**Format:**

```matlab
xASL_bids_BIDS2Legacy_ParseModality(BIDS, bidsPar, SubjectVisit, iSubjSess, ModalitiesUnique, nModalities, bOverwrite, pathLegacy_SubjectVisit)
```

**Description:**

Parse modality for BIDS to Legacy conversion.



----
### xASL\_bids\_BIDS2Legacy\_ParseScanType.m

**Format:**

```matlab
xASL_bids_BIDS2Legacy_ParseScanType(modalityConfiguration, SubjectVisit, RunsUnique, RunsAre, bOverwrite, Reference, bidsPar, ModalityIs, iSubjSess, BIDS, ModalityFields, pathLegacy_SubjectVisit)
```

**Description:**

Parse scan type during BIDS to Legacy conversion.



----
### xASL\_bids\_BIDS2xASL\_CopyFile.m

**Format:**

```matlab
xASL_bids_BIDS2xASL_CopyFile(pathOrig, pathDest, bOverwrite)
```

**Description:**

Copy files for BIDS to Legacy conversion.



----
### xASL\_imp\_AppendNiftiParameters.m

**Format:**

```matlab
s = xASL_imp_AppendNiftiParameters(nii_files)
```

**Description:**

Append Nifti Parameters.


----
### xASL\_imp\_AppendParmsParameters.m

**Format:**

```matlab
[s, FieldNames] = xASL_imp_AppendParmsParameters(parms)
```

**Description:**

Append Parms Parameters.


----
### xASL\_imp\_BIDS2Legacy.m

**Format:**

```matlab
[x] = xASL_imp_BIDS2Legacy(x);
```

**Description:**

BIDS to Legacy conversion script which calls xASL\_bids\_BIDS2Legacy.

1. Input check
2. Start with checking dataset\_description.json & rawdata
- 1. The input is dataset\_description.json in the rawdata folder
- 2. The input is dataPar.json or sourceStructure.json - have to look for a rawdata folder
3. Run the legacy conversion: Check if a dataPar is provided, otherwise use the defaults



----
### xASL\_imp\_BasicParameterChecks.m

**Format:**

```matlab
x = xASL_imp_BasicParameterChecks(x)
```

**Description:**

Basic parameter checks for the import pipeline.

- check that x.dir.DatasetRoot is correct
- determine x.dir.sourceStructure
- determine x.dir.studyPar
- check x.opts.ImportModules
- set the defaults for ...
- x.modules.import.settings.bCopySingleDicoms
- x.modules.import.settings.bUseDCMTK
- x.modules.import.settings.bCheckPermissions



----
### xASL\_imp\_CatchErrors.m

**Format:**

```matlab
[dcm2niiCatchedErrors] = xASL_imp_CatchErrors(WarningID, WarningMessage, WarningLine, WarningFileName, WarningPath, scan_name, scanpath, destdir, dcm2niiCatchedErrors, imPar, StackIn)
```

**Description:**

Catch reported warnings/errors, print them if verbose, & add them to a structure of warnings/errors to be stored for later QC.



----
### xASL\_imp\_CheckDirectoriesAndPermissions.m

**Format:**

```matlab
[x] = xASL_imp_CheckDirectoriesAndPermissions(x)
```

**Description:**

Check directories and permissions.

- Check if the RawRoot exists
- Search for temp, derivatives, source and sourcedata
- Raise error if not a single directory exists
- Check the access rights for temp and rawdata
- DCMTK & DicomInfo realted settings



----
### xASL\_imp\_CheckImportSettings.m

**Format:**

```matlab
[x] = xASL_imp_CheckImportSettings(x)
```

**Description:**

Basic import checks before execution.

- Check permissions for DCM2NII
- Get correct DCMNII version
- Define DCM Extension Filter
- Set default for skip subjects option



----
### xASL\_imp\_CompleteBIDS2Legacy.m

**Format:**

```matlab
x = xASL_imp_CompleteBIDS2Legacy(x)
```

**Description:**

Finish the remaining import steps, which are not done for each subject individually.

1. Create dataPar.json
2. Copy participants.tsv
3. Copy dataset\_description JSON and add 'GeneratedBy' fields
4. Add missing fields



----
### xASL\_imp\_CreateSummaryFile.m

**Format:**

```matlab
xASL_imp_CreateSummaryFile(thisSubject, imPar, PrintDICOMFields, x)
```

**Description:**

Create summary file.

1. Create summary file
2. Report totals

For the detailed description of the overview sub-structure (thisSubject & thisVisit)
please check out the description within xASL\_imp\_DetermineSubjectStructure.



----
### xASL\_imp\_DCM2NII.m

**Format:**

```matlab
x = xASL_imp_DCM2NII(x, imPar)
```

**Description:**

Run the dcm2nii part of the import.

1. Initialize defaults of dcm2nii
2. Create the temp directory for DCM2NII
3. Import visit by visit, session by session, scan by scan for current subject
4. Create summary file
5. Clean-up



----
### xASL\_imp\_DCM2NII\_CheckIfFME.m

**Format:**

```matlab
[resultJSON, bTimeEncoded, bTimeEncodedFME] = xASL_imp_DCM2NII_CheckIfFME(nii_files, bTimeEncoded, bTimeEncodedFME)
```

**Description:**

Check if the current sequence is a FME (Fraunhofer Mevis) time encoded sequence.



----
### xASL\_imp\_DCM2NII\_ConvertScan.m

**Format:**

```matlab
[x,imPar,thisSubject,dcm2niiCatchedErrors,PrintDICOMFields] = xASL_imp_DCM2NII_ConvertScan(x,imPar,matches,thisSubject,dcm2niiCatchedErrors,thisVisit,thisRun,scanFields)
```

**Description:**

Run DCM2NII for one individual scan.

4. Iterate over scans
-  1. Initialize variables (scanID, summary\_line, first\_match)
-  2. Convert scan ID to a suitable name and set scan-specific parameters
-  3. Minimalistic feedback of where we are
-  4. Now pick the matching one from the folder list
-  5. Determine input and output paths
-  6. Start the conversion if this scan should not be skipped
-  7. Store JSON files
-  8. In case of a single NII ASL file loaded from PAR/REC, we need to shuffle the dynamics from CCCC...LLLL order to CLCLCLCL... order
-  9  Copy single dicom as QC placeholder
- 10. Store the summary info so it can be sorted and printed below



----
### xASL\_imp\_DCM2NII\_ReorderTimeEncoded.m

**Format:**

```matlab
xASL_imp_DCM2NII_ReorderTimeEncoded(nii_files, bTimeEncoded, resultJSON)
```

**Description:**

Reorder TEs and PLDs accordingly for time encoded sequences.



----
### xASL\_imp\_DCM2NII\_SanityChecks.m

**Format:**

```matlab
xASL_imp_DCM2NII_SanityChecks(x)
```

**Description:**

Sanity check for missing elements.



----
### xASL\_imp\_DCM2NII\_Subject.m

**Format:**

```matlab
[x, imPar, PrintDICOMFields, dcm2niiCatchedErrors] = xASL_imp_DCM2NII_Subject(x, imPar, matches, dcm2niiCatchedErrors)
```

**Description:**

Run DCM2NII for one individual subject.

1. Run DCM2NII for one individual subject
2. Iterate over visits
3. Loop through all sessions
4. Iterate over scans



----
### xASL\_imp\_DCM2NII\_Subject\_SortASLVolumes.m

**Format:**

```matlab
[x, nii_files, summary_line, globalCounts, ASLContext] = xASL_imp_DCM2NII_Subject_SortASLVolumes(x, globalCounts, scanpath, scan_name, nii_files, iSubject, iVisit, iSession, iScan)
```

**Description:**

Sort ASL Volumes.

1. Fallbacks
2. Fill NIfTI Table
3. Get ASL context if possible
4. Only try shuffling if you dont know the ASL context already
5. Merge NIfTIs if there are multiples for ASL or M0, merge multiple files
6. Extract relevant parameters from nifti header and append to summary file



----
### xASL\_imp\_DCM2NII\_Subject\_StartConversion.m

**Format:**

```matlab
[imPar, globalCounts, x, summary_line, destdir, scanpath, scan_name, dcm2niiCatchedErrors, nii_files, first_match] = xASL_imp_DCM2NII_Subject_StartConversion(imPar, globalCounts, x, bSkipThisOne, summary_line, destdir, scanpath, scan_name, dcm2niiCatchedErrors)
```

**Description:**

Start of DCM2NII subject conversion.



----
### xASL\_imp\_DCM2NII\_Subject\_StoreJSON.m

**Format:**

```matlab
[parms, pathDcmDict] = xASL_imp_DCM2NII_Subject_StoreJSON(imPar, SavePathJSON, first_match, bUseDCMTK, pathDcmDict)
```

**Description:**

Store JSON.



----
### xASL\_imp\_Deface.m

**Format:**

```matlab
xASL_imp_Deface(x, imPar)
```

**Description:**

Run defacing.

1. Iterate over list of subjects
2. Get subject labels
3. Process all anatomical files (`xASL\_spm\_deface`)



----
### xASL\_imp\_DetermineStructureFromSourcedata.m

**Format:**

```matlab
[x] = xASL_imp_DetermineStructureFromSourcedata(x)
```

**Description:**

Determine structure from sourcedata.



----
### xASL\_imp\_DetermineSubjectStructure.m

**Format:**

```matlab
x = xASL_imp_DetermineSubjectStructure(x)
```

**Description:**

Determine subject/session/run structure from sourcedata or temp data.

The main goal is to create a sub-structure of x called x.overview.
x.overview does include a separate field for each subject.
Each subject has visit fields and visits have run fields.
All of this is used to track the number of subjects, number of visits, number of runs,
number of scans, etc. reliably. Within later parts of the pipeline it is also possible
to extract the current subject, current visit or current run to determine the part of
a population/subject/visit/run we're working on right now. We mostly used the variables
thisSubject, thisVisit, etc. for that.



----
### xASL\_imp\_ImportInitialization.m

**Format:**

```matlab
x = xASL_imp_ImportInitialization(x)
```

**Description:**

Initialization before xASL\_module\_Import.



----
### xASL\_imp\_Initialize.m

**Format:**

```matlab
imPar = xASL_imp_Initialize(studyPath, imParPath)
```

**Description:**

Initialize DCM2NII.

1. Read study file
2. Specify paths
3. Finalize the directories
4. Specify the tokens
5. Specify the additional details of the conversion



----
### xASL\_imp\_NII2BIDS.m

**Format:**

```matlab
x = xASL_imp_NII2BIDS(x, imPar, studyPath, studyParPath)
```

**Description:**

Run the NII2BIDS conversion.

1. Load the study parameters + dataset description
2. Create the study description output and verify that all is there
3. Go through all subjects and check all the M0 and ASLs and modify the JSONs



----
### xASL\_imp\_NII2BIDS\_Run.m

**Format:**

```matlab
x = xASL_imp_NII2BIDS_Run(x, imPar, bidsPar, studyPar, listRuns, nameSubjectSession, bidsLabel, iRun)
```

**Description:**

NII2BIDS conversion for a single run.

1. Make a subject directory with a correct session name
2. Convert structural and ASL runs



----
### xASL\_imp\_NII2BIDS\_RunAnat.m

**Format:**

```matlab
xASL_imp_NII2BIDS_RunAnat(bidsPar, studyPar, subjectSessionLabel, outSessionPath, listRuns, iRun, nameSubjectSession)
```

**Description:**

NII2BIDS conversion for a single sessions, single run.



----
### xASL\_imp\_NII2BIDS\_RunPerf.m

**Format:**

```matlab
xASL_imp_NII2BIDS_RunPerf(imPar, bidsPar, studyPar, subjectSessionLabel, inSessionPath, outSessionPath, listRuns, iRun)
```

**Description:**

NII2BIDS conversion for a single sessions, single run.

1. Define the pathnames
2. Load the JSONs and NIfTI information
3. BIDSify ASL
4. Prepare the link to M0 in ASL.json
5. BIDSify M0
6. Save all ASL files (JSON, NIFTI, CONTEXT) to the BIDS directory



----
### xASL\_imp\_NII2BIDS\_Subject.m

**Format:**

```matlab
x = xASL_imp_NII2BIDS_Subject(x, imPar, bidsPar, studyPar, nameSubject)
```

**Description:**

Run NII to ASL-BIDS for one individual subject.

1. Initialize
2. Process the anat & perfusion files
- 1. Make a subject directory
- 2. Iterate over sessions
- 3. Iterate over runs



----
### xASL\_imp\_NII2BIDS\_Subject\_DefineM0Type.m

**Format:**

```matlab
[jsonLocal, bJsonLocalM0isFile] = xASL_imp_NII2BIDS_Subject_DefineM0Type(studyPar, bidsPar, jsonLocal, pathM0, linkM0prefix)
```

**Description:**

Define M0 Type



----
### xASL\_imp\_PreallocateGlobalCounts.m

**Format:**

```matlab
x = xASL_imp_PreallocateGlobalCounts(x)
```

**Description:**

Preallocate space for (global) counts.



----
### xASL\_imp\_ReadSourceData.m

**Format:**

```matlab
x = xASL_imp_ReadSourceData(x)
```

**Description:**

Read source data.



----
### xASL\_imp\_TokenBackwardsCompatibility.m

**Format:**

```matlab
imPar = xASL_imp_TokenBackwardsCompatibility(imPar)
```

**Description:**

Fix the token backwards compatibility.



----
### xASL\_imp\_UpdateDatasetRoot.m

**Format:**

```matlab
x = xASL_imp_UpdateDatasetRoot(x)
```

**Description:**

Update x.opts.DatasetRoot to dataset\_description.json after NII2BIDS conversion


